"use strict";var express=require("express"),fs=require("fs"),expressJwt=require("express-jwt"),jwt=require("jsonwebtoken"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),Token=require("./token"),mysql=require("mysql"),formidable=require("express-formidable"),multiparty=require("multiparty"),home=express.Router();home.use(bodyParser.urlencoded({extended:!1})),home.use(cookieParser()),home.use(formidable()),home.use(expressJwt({secret:Token.scrict,algorithms:["HS256"],getToken:function(e){return e.cookies.curToken?e.cookies.curToken.split(" ")[1]:null}}).unless({path:["/login"]})),home.use(function(e,o,s,n){"UnauthorizedError"===e.name&&(s.status(401).send({msg:"invalid token..."}),console.log("token校验失败"))}),home.use("/home",function(e,o){console.log("用户进入user界面"),o.send({err:0,msg:"登录成功，欢迎使用垃圾分类管理系统！"})}),home.use("/autoLogin",function(e,o){console.log("用户正在尝试自动登录"),o.send({err:0,msg:"登录成功！"})}),home.use("/upload_info",function(e,s){var o=e.user.idCode,n=mysql.createConnection({host:"localhost",user:"root",password:"",database:"gcms-db"});n.connect(function(e){e?console.log("数据库链接失败"):console.log("链接成功！")}),n.query("select name,profile,email,phone from user_info where idCode=".concat(o),function(e,o){e?console.log(e):s.send({name:o[0].name,profile:o[0].profile,email:o[0].email,phone:o[0].phone})})}),home.use("/update_info",function(e,s){var o=e.fields,n=o.email,r=o.tel,c=o.profile_base64URL,t=o.idCode;console.log("用户"+t+"尝试修改信息中");var l=mysql.createConnection({host:"localhost",user:"root",password:"",database:"gcms-db"});l.connect(function(e){e?console.log("数据库链接失败"):console.log("链接成功！")}),"undefined"!==c&&l.query('update user_info set profile="'.concat(c,'" where idCode=').concat(t),function(e,o){e?console.log(e):console.log("头像修改成功")}),l.query('update user_info set phone="'.concat(r,'",email="').concat(n,'" where idCode=').concat(t),function(e,o){e?console.log(e):(console.log("信息修改成功"),s.send({err:0,msg:"信息修改成功"}))})}),home.post("/update_pwd",function(e,s){console.log(e.fields);var o=e.fields,n=o.oldPwd,r=o.newPwd,c=(o.confirmPwd,o.idCode);console.log("用户"+c+"正在尝试修改密码");var t=mysql.createConnection({host:"localhost",user:"root",password:"",database:"gcms-db"});t.connect(function(e){e?console.log("数据库链接失败"):console.log("链接成功！")}),t.query("select pwd from user_account where idCode=".concat(c),function(e,o){if(e)console.log(e);else{if(n!==o[0].pwd)return s.send({err:"oldPwd",msg:"旧密码验证错误"});t.query("update user_account set pwd='".concat(r,"' where idCode=").concat(c,' and school="').concat(SName,'"')),s.clearCookie("curToken").send({err:0,msg:"修改成功"})}})}),module.exports=home;