"use strict";var express=require("express"),Token=require("./token"),expressJwt=require("express-jwt"),jwt=require("jsonwebtoken"),formidable=require("express-formidable"),mysql=require("mysql"),router=express.Router();router.use(formidable()),router.post("/",function(e,s){console.log("尝试登录中..."),console.log(e.fields);var o=e.fields,n=o.SName,c=o.idCode,l=o.password,t=o.identiy,d=mysql.createConnection({host:"localhost",user:"root",password:"",database:"gcms-db"});d.connect(function(e){e?console.log("数据库链接失败"):console.log("链接成功！")}),console.log("查找"+t+"表中..."),d.query("select count(*) from ".concat(t,'_account where school="').concat(n,'" and idCode=').concat(c),function(e,o){e?(console.log("query error!"),console.log(e)):(console.log(o),0===o[0]["count(*)"]?(console.log("学号/工号不存在，返回错误信息"),s.send({err:"idCode",msg:"学号/工号不存在"})):d.query("select * from ".concat(t,"_account where idCode=").concat(c),function(e,o){if(console.log("学号/工号存在，正在校验信息"),e)console.log(e);else if(l===o[0].pwd&&n===o[0].school){var r=Token.createToken({login:!0,address:n,idCode:c,identiy:t});s.cookie("curToken",r,{maxAge:6048e5,path:"/",httpOnly:!0}),s.send({err:0,msg:"登录成功",link:"./".concat(t,".html")}),console.log(t+"用户"+c+"登录成功")}else l!==o[0].pwd&&s.send({err:"pwd",msg:"密码错误"});d.end()}))})}),module.exports=router;