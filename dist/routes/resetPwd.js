"use strict";var express=require("express"),formidable=require("express-formidable"),nodemailer=require("nodemailer"),mail=require("./nodemail"),mysql=require("mysql"),verify_codes={},app=express.Router();app.use(formidable()),app.post("/get_verifyCode",function(e,o){var r=e.headers.email,s=(e.headers.idCode,parseInt(1e4*Math.random()));r&&(verify_codes[r]=s),console.log(verify_codes),mail.sendMail(r,s).then(function(){o.send({err:0,msg:"验证码已发送"})}).catch(function(){o.send({err:1,msg:"验证码发送失败"})})}),app.post("/",function(e,r){var o=e.fields,s=o.SName,n=o.idCode,c=o.email,a=o.verifyCode,i=o.newPwd;console.log("用户"+n+"正在尝试重置密码");var l=mysql.createConnection({host:"localhost",user:"root",password:"",database:"gcms-db"});l.connect(function(e){e?console.log("数据库链接失败"):console.log("链接成功！")}),l.query('select count(*) from user_account where school="'.concat(s,'" and idCode=').concat(n),function(e,o){e?console.log(e):(console.log(o),0===o[0]["count(*)"]?(console.log("学号/工号不存在，返回错误信息"),r.send({err:"idCode",msg:"学号/工号不存在"})):l.query('select email from user_info where idCode="'.concat(n,'"'),function(e,o){if(e)console.log(e);else{if(o[0].email!==c)return r.send({err:"email",msg:"邮箱与账号不符合！"});if(a!=verify_codes[c])return r.send({err:"verifyCode",msg:"验证码错误！"});l.query('update user_account set pwd="'.concat(i,'" where idCode=').concat(n,' and school="').concat(s,'"'),function(e,o){e?console.log(e):(console.log("密码重置成功"),r.send({err:0,msg:"密码重置成功！"}))})}}))})}),module.exports=app;